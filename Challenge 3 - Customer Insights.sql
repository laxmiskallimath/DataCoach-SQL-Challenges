CREATE DATABASE CUSTOMERS;
USE CUSTOMERS;

CREATE TABLE COUNTRY(
COUNTRY_ID INT PRIMARY KEY,
COUNTRY_NAME VARCHAR(50),
HEAD_OFFICE VARCHAR(50)
);

INSERT INTO country (country_id, country_name, head_office)
VALUES (1, 'UK', 'London'),
(2, 'USA', 'New York'),
(3, 'China', 'Beijing');

SELECT * FROM COUNTRY;

CREATE TABLE customers (
customer_id INT PRIMARY KEY,
first_shop DATE,
age INT,
rewards VARCHAR(50),
can_email VARCHAR(50)
);

INSERT INTO customers (customer_id, first_shop, age, rewards, can_email)
VALUES (1, '2022-03-20', 23, 'yes', 'no'),
(2, '2022-03-25', 26, 'no', 'no'),
(3, '2022-04-06', 32, 'no', 'no'),
(4, '2022-04-13', 25, 'yes', 'yes'),
(5, '2022-04-22', 49, 'yes', 'yes'),
(6, '2022-06-18', 28, 'yes', 'no'),
(7, '2022-06-30', 36, 'no', 'no'),
(8, '2022-07-04', 37, 'yes', 'yes');


CREATE TABLE orders (
order_id INT PRIMARY KEY,
customer_id INT,
date_shop DATE,
sales_channel VARCHAR(50),
country_id INT,
FOREIGN KEY (customer_id) REFERENCES customers(customer_id),
FOREIGN KEY (country_id) REFERENCES country(country_id)
);

INSERT INTO orders (order_id, customer_id, date_shop, sales_channel, country_id)
VALUES (1, 1, '2023-01-16', 'retail', 1),
(2, 4, '2023-01-20', 'retail', 1),
(3, 2, '2023-01-25', 'retail', 2),
(4, 3, '2023-01-25', 'online', 1),
(5, 1, '2023-01-28', 'retail', 3),
(6, 5, '2023-02-02', 'online', 1),
(7, 6, '2023-02-05', 'retail', 1),
(8, 3, '2023-02-11', 'online', 3);
--------------------
CREATE TABLE products (
product_id INT PRIMARY KEY,
category VARCHAR(50),
price NUMERIC(5,2)
);
--------------------
INSERT INTO products (product_id, category, price)
VALUES (1, 'food', 5.99),
(2, 'sports', 12.49),
(3, 'vitamins', 6.99),
(4, 'food', 0.89),
(5, 'vitamins', 15.99);

CREATE TABLE baskets (
order_id INT,
product_id INT,
FOREIGN KEY (order_id) REFERENCES orders(order_id),
FOREIGN KEY (product_id) REFERENCES products(product_id)
);
--------------------
INSERT INTO baskets (order_id, product_id)
VALUES (1, 1),
(1, 2),
(1, 5),
(2, 4),
(3, 3),
(4, 2),
(4, 1),
(5, 3),
(5, 5),
(6, 4),
(6, 3),
(6, 1),
(7, 2),
(7, 1),
(8, 3),
(8, 3);

--- -- Questions
-- 1. What are the names of all the countries in the country table?

SELECT * FROM COUNTRY;

SELECT
    COUNTRY_NAME  AS COUNTRIES
FROM COUNTRY;

/*
China
UK
USA
*/

-- 2. What is the total number of customers in the customers table?

SELECT * FROM CUSTOMERS;

SELECT 
COUNT(CUSTOMER_ID) AS TOTAL_NUMBER_OF_CUSTOMERS
FROM customers;
-- RESULT
/*
TOTAL_NUMBER_OF_CUSTOMERS
8
*/

-- 3. What is the average age of customers who can receive marketing emails (can_email is set to 'yes')?

SELECT 
     ROUND(avg(AGE)) avg_age 
FROM customers
WHERE CAN_EMAIL = 'YES';
/*
avg_age
37
*/

-- 4. How many orders were made by customers aged 30 or older?
SELECT 
     COUNT(ORDER_ID) AS NO_OF_ORDERS
FROM 
     ORDERS O1
 JOIN 
     CUSTOMERS C1
     ON  O1.CUSTOMER_ID = C1.CUSTOMER_ID
WHERE 
     AGE >= 30;
 /*    
NO_OF_ORDERS
3
*/

-- 5. What is the total revenue generated by each product category?
SELECT 
      CATEGORY,
     SUM(PRICE) AS TOTAL_REVENUE
FROM 
     PRODUCTS P1
    JOIN 
     BASKETS B1
    ON 
    P1.PRODUCT_ID  = B1.PRODUCT_ID
GROUP BY 
     CATEGORY
ORDER BY 
      TOTAL_REVENUE DESC;

-- 6. What is the average price of products in the 'food' category?
SELECT 
CATEGORY,
      ROUND(AVG(PRICE)) AS AVG_PRICE
FROM PRODUCTS
WHERE CATEGORY = 'FOOD'
GROUP BY CATEGORY;

-- 7. How many orders were made in each sales channel (sales_channel column) in the orders table?
-- ORDERS
-- SALES CHANNEL 

SELECT 
      SALES_CHANNEL,
      COUNT(ORDER_ID) AS NO_OF_ORDERS
FROM ORDERS
GROUP BY SALES_CHANNEL
ORDER BY NO_OF_ORDERS DESC;

/*
SALES_CHANNEL, NO_OF_ORDERS
online	         3
retail	         5
*/

-- 8.What is the date of the latest order made by a customer who can receive marketing emails?
SELECT 
     MAX(DATE_SHOP) as latest_order_date
FROM 
     ORDERS O1
JOIN
     CUSTOMERs C1
ON 
   O1.CUSTOMER_ID = C1.CUSTOMER_ID
WHERE 
     CAN_EMAIL = 'yes';
     
-- latest_order_date
/*
'2023-02-02'
*/

-- 9. What is the name of the country with the highest number of orders?

WITH CTE AS
(
SELECT 
      COUNTRY_NAME,
      COUNT(ORDER_ID) AS NO_OF_ORDERS,
      DENSE_RANK() OVER (ORDER BY COUNT(ORDER_ID) DESC) AS DENSERANK
FROM 
      ORDERS O1
JOIN
     COUNTRY C1
ON 
    O1.COUNTRY_ID = C1.COUNTRY_ID
GROUP BY 
      COUNTRY_NAME
ORDER BY  NO_OF_ORDERS DESC)
SELECT 
      COUNTRY_NAME,
      NO_OF_ORDERS,
	  DENSERANK
FROM 
     CTE
WHERE 
     DENSERANK = 1;
     
/*
# COUNTRY_NAME, NO_OF_ORDERS, DENSERANK
'UK',            '5',          '1'

*/


-- 10. What is the average age of customers who made orders in the 'vitamins' product category?
SELECT 
     CATEGORY,
     ROUND(AVG(AGE)) AS AVG_AGE
FROM 
    CUSTOMERS C1
JOIN 
    ORDERS O1
ON 
   C1.CUSTOMER_ID = O1.CUSTOMER_ID
JOIN
 BASKETS B1
ON 
   B1.ORDER_ID = O1.ORDER_ID
JOIN
   PRODUCTS P1
ON
   B1.PRODUCT_ID = P1.PRODUCT_ID
WHERE 
P1.CATEGORY = 'VITAMINS'
GROUP BY CATEGORY;

/*
CATEGORY, AVG_AGE
vitamins,  30
  */
  
  

